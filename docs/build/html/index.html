<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Speeding up Machine Learning using a high-performance Go proxy. &mdash; social_media 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="social_media 1.0 documentation" href="#" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="speeding-up-machine-learning-using-a-high-performance-go-proxy">
<h1>Speeding up Machine Learning using a high-performance Go proxy.<a class="headerlink" href="#speeding-up-machine-learning-using-a-high-performance-go-proxy" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<p>At times I want to grab a bunch of data, use it, and spit something out the other end. From time to time I get paid to do this, too. But the world of online dependencies is far less predictable than I&#8217;d like it to be, a quick browse of your own bookmarks should confirm this to you. Anything that can add predictability to my workflow is surely something worth investing in, and incorporating into my toolset.</p>
<div class="figure">
<img alt="hat" src="_images/hat.jpg" />
</div>
<p>Well I recently came across an ultra-high-performance proxy, written in Go, called <a class="reference external" href="http://www.hoverfly.io/">HoverFly</a>. So I decided to write a light-weight Python binding to it: <a class="reference external" href="http://www.hoverpy.io/">HoverPy</a>. HoverFly enables me to offline any data I want, while still being able to interact with it as if I were hitting the real endpoint. In this short article, I&#8217;ll take you through using this very thin Python layer to build a classifier using scikit-learn, with HackerNews and Reddit as its endpoints.</p>
<p>What I really, really like about Hoverfly, is that it loads so fast in the background. Working with it feels completely transparent, requires zero configuration, and as you&#8217;ll see I can include its data in my repos; pull that data in for my main functionality, and for my unit testing too. This makes my work 100% water-tight, blazingly fast, and <strong>utterly failure proof</strong>.</p>
<p>Let&#8217;s begin by cloning the only repo we&#8217;ll need for this post:</p>
<div class="highlight-bash"><div class="highlight"><pre>git clone https://github.com/shyal/hoverpy-scikitlearn.git
<span class="nb">cd </span>hoverpy-scikitlearn
virtualenv .venv
<span class="nb">source</span> .venv/bin/activate
pip install -i https://testpypi.python.org/pypi hoverpy
pip install haxor praw
</pre></div>
</div>
<div class="section" id="data-mining-hackernews-and-reddit">
<h2>Data mining HackerNews and Reddit<a class="headerlink" href="#data-mining-hackernews-and-reddit" title="Permalink to this headline">¶</a></h2>
<p>Now that we have our environment setup, let&#8217;s delve straight in by getting the top 100 posts on HackerNews. To do so, feel free to spin up your <code class="docutils literal"><span class="pre">python</span></code> shell and paste this in, or pass it to the python interpreter with <code class="docutils literal"><span class="pre">python</span> <span class="pre">lib/hnMiner.py</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hoverpy</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">hackernews</span> <span class="kn">import</span> <span class="n">HackerNews</span>
<span class="kn">from</span> <span class="nn">hackernews</span> <span class="kn">import</span> <span class="n">settings</span>


<span class="k">def</span> <span class="nf">getHNData</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="s">&quot;showstories&quot;</span><span class="p">):</span>
    <span class="n">dbpath</span> <span class="o">=</span> <span class="s">&quot;data/hn.</span><span class="si">%s</span><span class="s">.db&quot;</span> <span class="o">%</span> <span class="n">sub</span>
    <span class="n">capture</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">hoverpy</span><span class="o">.</span><span class="n">HoverPy</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="n">capture</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="n">dbpath</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">capture</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">supported_api_versions</span><span class="p">[</span>
                <span class="s">&quot;v0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;http://hacker-news.firebaseio.com/v0/&quot;</span>

        <span class="n">hn</span> <span class="o">=</span> <span class="n">HackerNews</span><span class="p">()</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;GETTING HACKERNEWS </span><span class="si">%s</span><span class="s"> DATA&quot;</span> <span class="o">%</span> <span class="n">sub</span><span class="p">)</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;showstories&quot;</span><span class="p">:</span> <span class="n">hn</span><span class="o">.</span><span class="n">show_stories</span><span class="p">,</span>
                <span class="s">&quot;askstories&quot;</span><span class="p">:</span> <span class="n">hn</span><span class="o">.</span><span class="n">ask_stories</span><span class="p">,</span>
                <span class="s">&quot;jobstories&quot;</span><span class="p">:</span> <span class="n">hn</span><span class="o">.</span><span class="n">job_stories</span><span class="p">,</span>
                <span class="s">&quot;topstories&quot;</span><span class="p">:</span> <span class="n">hn</span><span class="o">.</span><span class="n">top_stories</span><span class="p">}</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">story_id</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">[</span><span class="n">sub</span><span class="p">](</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">):</span>
            <span class="n">story</span> <span class="o">=</span> <span class="n">hn</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">story_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">story</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">story</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">&quot;got </span><span class="si">%i</span><span class="s"> hackernews titles in </span><span class="si">%f</span><span class="s"> seconds&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">titles</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">getHNData</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="s">&quot;topstories&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash"><div class="highlight"><pre>got <span class="m">100</span> hackernews titles in 14.678717 seconds
</pre></div>
</div>
<p>You may notice a bolt database was created inside the <code class="docutils literal"><span class="pre">./data</span></code> directory:</p>
<div class="highlight-bash"><div class="highlight"><pre>ll data/hn.topstories.db
-rw-------  <span class="m">1</span> ioloop  staff  <span class="m">262144</span> Dec <span class="m">13</span> 15:27 data/hn.topstories.db
</pre></div>
</div>
<p>Let&#8217;s run the same command again:</p>
<div class="highlight-bash"><div class="highlight"><pre>python lib/hnMiner.py
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash"><div class="highlight"><pre>got <span class="m">100</span> hackernews titles in 0.180554 seconds
</pre></div>
</div>
<p>This is roughly an <strong>80x speedup</strong>, <em>hitting our endpoint is starting to feel more like hitting a database</em> which is probably the key point to this chapter.</p>
<p>Note regarding reddit: we can do the same with <a class="reference external" href="https://raw.githubusercontent.com/shyal/hoverpy-scikitlearn/master/lib/redditMiner.py">lib/redditMiner.py</a>: <code class="docutils literal"><span class="pre">python</span> <span class="pre">lib/redditMiner.py</span></code>. But I think you got the picture.</p>
</div>
<hr class="docutils" />
<div class="section" id="putting-our-miners-together">
<h2>Putting our miners together<a class="headerlink" href="#putting-our-miners-together" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s go ahead and write a <code class="docutils literal"><span class="pre">doMining</span></code> function that&#8217;ll bring in all the data we need from the HN sections, and Reddit subs. You&#8217;ll need to run this file directly, as it&#8217;s in the <code class="docutils literal"><span class="pre">./lib</span></code> folder, unless you want to sit around while all the data re-downloads (you don&#8217;t).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">subs</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;hn&#39;</span><span class="p">,</span> <span class="s">&#39;showstories&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;hn&#39;</span><span class="p">,</span> <span class="s">&#39;askstories&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;hn&#39;</span><span class="p">,</span> <span class="s">&#39;jobstories&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;republican&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;democrat&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;linux&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;music&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;movies&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;literature&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;reddit&#39;</span><span class="p">,</span> <span class="s">&#39;books&#39;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">doMining</span><span class="p">():</span>

    <span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kn">from</span> <span class="nn">hnMiner</span> <span class="kn">import</span> <span class="n">getHNData</span>
    <span class="kn">from</span> <span class="nn">redditMiner</span> <span class="kn">import</span> <span class="n">getRedditData</span>

    <span class="n">getter</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;hn&#39;</span><span class="p">:</span> <span class="n">getHNData</span><span class="p">,</span> <span class="s">&#39;reddit&#39;</span><span class="p">:</span> <span class="n">getRedditData</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)):</span>
        <span class="n">subTitles</span> <span class="o">=</span> <span class="n">getter</span><span class="p">[</span><span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]](</span>
            <span class="n">sub</span><span class="o">=</span><span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">titles</span> <span class="o">+=</span> <span class="n">subTitles</span>
        <span class="n">target</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">subTitles</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">titles</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">doMining</span><span class="p">()</span>
</pre></div>
</div>
<p>command:</p>
<div class="highlight-bash"><div class="highlight"><pre>python lib/dataMiner.py
</pre></div>
</div>
<p>That&#8217;s really all we need, and thanks to HoverFly the entire process, once cached, is blazingly fast. Let&#8217;s move on to our next step.</p>
</div>
<div class="section" id="building-an-hn-or-reddit-classifier">
<h2>Building an HN or Reddit classifier<a class="headerlink" href="#building-an-hn-or-reddit-classifier" title="Permalink to this headline">¶</a></h2>
<p>Well now that we can transparently cache our dependencies, let&#8217;s build something interesting. We are going to build a classifier that predicts whether text may have come from HN or Reddit, and also specifically which sub.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python social_media.py
</pre></div>
</div>
<p>This spins up our classifier:</p>
<script type="text/javascript" src="https://asciinema.org/a/626zkc3hduwfd7328aqme4wgl.js" id="asciicast-626zkc3hduwfd7328aqme4wgl" async></script><p>This is our whole classifier, and application entry point, <code class="docutils literal"><span class="pre">./social_media.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">lib</span> <span class="kn">import</span> <span class="n">dataMiner</span>

<span class="n">titles</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">dataMiner</span><span class="o">.</span><span class="n">doMining</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">MultinomialNB</span>

<span class="n">count_vect</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>
<span class="n">X_train_counts</span> <span class="o">=</span> <span class="n">count_vect</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span>

<span class="n">tfidf_transformer</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
<span class="n">X_train_tfidf</span> <span class="o">=</span> <span class="n">tfidf_transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_counts</span><span class="p">)</span>

<span class="n">clf</span> <span class="o">=</span> <span class="n">MultinomialNB</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_tfidf</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sentences</span><span class="p">):</span>
    <span class="n">X_new_counts</span> <span class="o">=</span> <span class="n">count_vect</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
    <span class="n">X_new_tfidf</span> <span class="o">=</span> <span class="n">tfidf_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_new_counts</span><span class="p">)</span>

    <span class="n">predicted</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new_tfidf</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">predicted</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> =&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">dataMiner</span><span class="o">.</span><span class="n">subs</span><span class="p">[</span><span class="n">category</span><span class="p">]))</span>

<span class="k">print</span> <span class="s">&quot;*&quot;</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">TEST CLASSIFIER</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;*&quot;</span><span class="o">*</span><span class="mi">30</span>

<span class="n">predict</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;./sentences.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">predict</span><span class="p">([</span><span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Enter title: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
</pre></div>
</div>
<p>Let&#8217;s break it down a little.</p>
<p>Scikit-learn has a high level component <code class="docutils literal"><span class="pre">CountVectorizer</span></code> that takes care of text preprocessing, tokenizing and filtering of stopwords for us. It transforms our text into feature vectors, in the form of a dictionary:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">count_vect</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>
<span class="n">X_train_counts</span> <span class="o">=</span> <span class="n">count_vect</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span>
</pre></div>
</div>
<p>You can check the score for various tokens, i.e.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">count_vect</span><span class="o">.</span><span class="n">vocabulary_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">u&quot;python&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The word python appears a total of 21567 in this corpus.</p>
<p>We need to build a tf–idf (term frequency times inverse document frequency) transformer.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">tfidf_transformer</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
<span class="n">X_train_tfidf</span> <span class="o">=</span> <span class="n">tfidf_transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_counts</span><span class="p">)</span>
</pre></div>
</div>
<p>This is to prevent larger documents to score higher, by having occurances score higher due to document size instead of token term relevance, which is why the fix is to divide the term frequencies by the document size.</p>
<p>And finally our <code class="docutils literal"><span class="pre">predict</span></code> function, which takes an array of sentences.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sentences</span><span class="p">):</span>
    <span class="n">X_new_counts</span> <span class="o">=</span> <span class="n">count_vect</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
    <span class="n">X_new_tfidf</span> <span class="o">=</span> <span class="n">tfidf_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_new_counts</span><span class="p">)</span>

    <span class="n">predicted</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new_tfidf</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">predicted</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> =&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">dataMiner</span><span class="o">.</span><span class="n">subs</span><span class="p">[</span><span class="n">category</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="taking-it-one-step-further-with-testing">
<h2>Taking it one step further with testing<a class="headerlink" href="#taking-it-one-step-further-with-testing" title="Permalink to this headline">¶</a></h2>
<p>At this point I&#8217;m hoping you see how water tight this code is. But one is never above unit testing. What is great is that, at this point, since we have zero external data dependencies, the chances of the tests failing are virtually none.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">lib</span> <span class="kn">import</span> <span class="n">hnMiner</span>


<span class="k">class</span> <span class="nc">test_hn</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stories</span> <span class="o">=</span> <span class="n">hnMiner</span><span class="o">.</span><span class="n">getHNData</span><span class="p">(</span><span class="n">sub</span><span class="o">=</span><span class="s">&quot;jobstories&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">stories</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;hiring&quot;</span> <span class="ow">in</span> <span class="n">story</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stories</span> <span class="o">=</span> <span class="n">hnMiner</span><span class="o">.</span><span class="n">getHNData</span><span class="p">(</span><span class="n">sub</span><span class="o">=</span><span class="s">&quot;showstories&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">stories</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;show&quot;</span> <span class="ow">in</span> <span class="n">story</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stories</span> <span class="o">=</span> <span class="n">hnMiner</span><span class="o">.</span><span class="n">getHNData</span><span class="p">(</span><span class="n">sub</span><span class="o">=</span><span class="s">&quot;askstories&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">stories</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;ask&quot;</span> <span class="ow">in</span> <span class="n">story</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">lib</span> <span class="kn">import</span> <span class="n">redditMiner</span>


<span class="k">class</span> <span class="nc">test_reddit</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">generic_sub_tester</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
        <span class="n">stories</span> <span class="o">=</span> <span class="n">redditMiner</span><span class="o">.</span><span class="n">getRedditData</span><span class="p">(</span><span class="n">sub</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">story</span> <span class="ow">in</span> <span class="n">stories</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">story</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_linux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generic_sub_tester</span><span class="p">(</span><span class="s">&quot;linux&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_linux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generic_sub_tester</span><span class="p">(</span><span class="s">&quot;python&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_music</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generic_sub_tester</span><span class="p">(</span><span class="s">&quot;music&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">test_classifier</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">scipy</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;scipy module not installed - quitting&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">lib</span> <span class="kn">import</span> <span class="n">dataMiner</span>

        <span class="n">titles</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">dataMiner</span><span class="o">.</span><span class="n">doMining</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span>
        <span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfTransformer</span>
        <span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">MultinomialNB</span>

        <span class="n">count_vect</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>
        <span class="n">X_train_counts</span> <span class="o">=</span> <span class="n">count_vect</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span>

        <span class="n">tfidf_transformer</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
        <span class="n">X_train_tfidf</span> <span class="o">=</span> <span class="n">tfidf_transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_counts</span><span class="p">)</span>

        <span class="n">clf</span> <span class="o">=</span> <span class="n">MultinomialNB</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_tfidf</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">answers</span><span class="p">):</span>
            <span class="n">X_new_counts</span> <span class="o">=</span> <span class="n">count_vect</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
            <span class="n">X_new_tfidf</span> <span class="o">=</span> <span class="n">tfidf_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_new_counts</span><span class="p">)</span>

            <span class="n">predicted</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new_tfidf</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">answer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">answers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">dataMiner</span><span class="o">.</span><span class="n">subs</span><span class="p">[</span><span class="n">category</span><span class="p">],</span> <span class="n">answer</span><span class="p">)</span>

        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&quot;powershell and openssl compatability testing&quot;</span><span class="p">,</span>
            <span class="s">&quot;compiling source code on ubuntu&quot;</span><span class="p">,</span>
            <span class="s">&quot;wifi drivers keep crashing&quot;</span><span class="p">,</span>
            <span class="s">&quot;training day was a great movie with a legendary director&quot;</span>
        <span class="p">]</span>

        <span class="n">answers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;reddit&quot;</span><span class="p">,</span> <span class="s">&quot;linux&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;reddit&quot;</span><span class="p">,</span> <span class="s">&quot;linux&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;reddit&quot;</span><span class="p">,</span> <span class="s">&quot;linux&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;reddit&quot;</span><span class="p">,</span> <span class="s">&quot;movies&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">predict</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">answers</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>In fact we can be so confident about our tests using HoverFly, that we can rest assured our travis tests will most likely never fail. No matter what.</p>
<a class="reference external image-reference" href="https://travis-ci.org/shyal/hoverpy-scikitlearn"><img alt="https://travis-ci.org/shyal/hoverpy-scikitlearn.svg?branch=master" src="https://travis-ci.org/shyal/hoverpy-scikitlearn.svg?branch=master" /></a>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="#">
              <img class="logo" src="_static/ioLogo.svg" alt="Logo"/>
            </a></p>
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Speeding up Machine Learning using a high-performance Go proxy.</a><ul>
<li><a class="reference internal" href="#data-mining-hackernews-and-reddit">Data mining HackerNews and Reddit</a></li>
<li><a class="reference internal" href="#putting-our-miners-together">Putting our miners together</a></li>
<li><a class="reference internal" href="#building-an-hn-or-reddit-classifier">Building an HN or Reddit classifier</a></li>
<li><a class="reference internal" href="#taking-it-one-step-further-with-testing">Taking it one step further with testing</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Shyal Beardsley.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>